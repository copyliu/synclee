{% extends "base.html"%}

{% block title %} {{work.name}} {% endblock %}

{% block content %}
<div class="container">
  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span3">
        <table class="table">
          <thead>
            <tr>
              <th colspan="2"><a href="#" class="thumbnail">
            <img src="/media/{{work.cover|default:"no_cover.gif"}}" width="100%" />
          </a></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="label label-info">企划名称</span></td>
              <td>{{work.name}}</td>
            </tr>
            <tr>
              <td><span class="label label-info">发起人</span></td>
              <td><a href="{%url profile work.author.username%}">{{work.author.username}}</a></td>
            </tr>
            <tr>
              <td><span class="label label-info">参与人</span></td>
              <td>
              {% for p in participated %}
              <li><a href="{%url profile p.username%}">{{p.username}}</a>
              	{% if work.author ==  request.user%}
              	<a class="class_work_quit" data-uid="{{p.id}}">&times;</a>
              	{% endif %}
              </li>
              {% endfor %}
              </td>
            </tr>
            <tr>
              <td width="60"><span class="label label-info">描述</span></td>
              <td>{{work.intro}}</td>
            </tr>
            <tr>
              <td width="60"><span class="label label-info">评分</span></td>
              <td><span id = "id_average_score">{{average_score}}</span>&nbsp;&nbsp;<small>已有<span id = "id_score_count">{{score_count}}</span>人评分</small>
              {% if request.user.is_authenticated %}
              <input type="submit" class="btn primary" id = "id_score_btn" data-toggle="modal" href = "#id_score" data-backdrop="true" data-keyboard="true" value="我来"></td>
              {% endif %}
            </tr>
            <tr>
              {% if not involved %}
              <td><button id="id_apply_btn" class="btn">加入</button></td>
              {% else %}
              <td><a href="{%url edit_work work.id %}"><button class="btn primary">编辑</button></a> <a href="{%url export_work work.id %}"><button class="btn primary">导出</button></a>
              {% if work.author !=  request.user%}
              	<button class="btn primary class_work_quit" data-uid="{{request.user.id}}">退出</button>
              {% endif %}
              </td>
	            {% endif %}
	            
	            {% if followed and not involved%}
	            <td><button type="submit" id="id_follow_btn" data-action="unfollow" class="btn">取消</button></td>
              {% endif %}
              {% if not followed and not involved%}
              <td><button type="submit" id="id_follow_btn" data-action="follow" class="btn btn-primary">关注</button></td>
              {% endif %}
            </tr>
            <tr> <td colspan="3"> <section>
              <div class="page-header">
					      <h3>编辑历史&nbsp;&nbsp;&nbsp;&nbsp;<a href="{%url list_works_history work.id%}"><small>更多...</small></a></h3>
			      	</div>
			      	{% for i in history%}
			      	<li><a href = "{%url profile i.user.username%}">{{i.user.username}}</a>于{{i.date|date:"j/n/Y H:i"}}进行了修改</li>
			      	{%endfor%}
            </section> </td> </tr>
          </tbody>
        </table>
      </div>
      <div class="span8">
      {% if request.user.is_authenticated %}
	    {% if request.user.username == work.author.username %}
	    <section id = "sec_apply">
	    </section>
	    {% endif %}
	    {% endif %}
      {% if elements %}
        <article></article>
      {% else %}
        当前work没有任何element
      {% endif %}
      </div>
  </div>
</div>

<div id="id_apply" class="modal hide fade">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h3>加入作品</h3>
  </div>
  <form method="post" action="{%url ajax_work_grade %}">
        {% csrf_token %}
  <div class="modal-body">
	<div class="clearfix">
      <label for="normalSelect">选择角色：</label>
	  <div class="input">
	    <select name="role" id="id_apply_role">
	      <option value = "image">画师</option>
		  <option value = "word">写手</option>
          <option value = "other">其他</option>
        </select>
      </div>
	</div>
	<div class="clearfix">
      <label for="textarea">申请理由：</label>
	  <div class="input">
	    <textarea class="large" id="id_apply_reason" name="reason" rows="5"></textarea>
      </div>
      <span class="help-block">最多300个字符</span>
	</div>
  </div>
  <div class="modal-footer">
  	<input type="hidden" name="uid" value="{{work.id}}" />
    <button class="btn btn-success">发送申请</button>
  </div>
  </form>
</div>

<div class="modal hide fade in" id="alertModal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>错误信息</h3>
  </div>
  <div class="modal-body">
    <p> </p>
  </div>
  <div class="modal-footer">
    <a href="/login/?next={%url show_work work.id %}" class="btn btn-success">&gt;&gt;跳转到登录页面</a>
  </div>
</div>

<div id="id_score" class="modal hide fade">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h3>作品评分</h3>
  </div>
  <form method="post" action="{%url ajax_user_apply %}">
        {% csrf_token %}
  <div class="modal-body">
	<div class="control-group">
    <label class="control-label" for="normalSelect">选择评分：</label>
	  <div class="input">
	    <select name="score" id="id_score_score">
	    	<option value = "1">1</option>
	    	<option value = "2">2</option>
	    	<option value = "3">3</option>
	    	<option value = "4">4</option>
	    	<option value = "5">5</option>
	    	<option value = "6">6</option>
	    	<option value = "7">7</option>
	    	<option value = "8">8</option>
	    	<option value = "9">9</option>
	    	<option value = "10">10</option>
      	</select>
    </div>
	</div>
  </div>
  <div class="modal-footer">
    <input type="hidden" name="uid" value="{{work.id}}" />
    <button class="btn btn-success">Submit</button>
  </div>
  </form>
</div>

<div id = "id_alert_notice" class="alert fade in">
  <a class="close" data-dismiss="alert" href="#">&times;</a>
  <p></p>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript" src="/static/js/bootstrap/bootstrap-modal.js"></script>
<script type="text/javascript" src="/static/js/jquery-ui-1.8.17.custom.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.uploadify.js"></script>
<script type="text/javascript" src="/static/js/ajax_csrf.js"></script>
<script>
$(document).ready(function(){
    var wid = {{work.id}};
    
    $("#id_follow_btn").click( function(){
        var action = $(this).data('action');
        {% if request.user.is_authenticated %}
        Controller.follow($(this), wid, action);
        {% else %}
        Controller.alert();
        {% endif %}
    });
    
    $('#id_apply_btn').click( function(){
        {% if request.user.is_authenticated %}
        $('#id_apply').modal({'show': true});
        {% else %}
        Controller.alert();
        {% endif %}
    });
    
    $('#id_apply form').submit(function(e){
        var data = $(this).serialize();
        {% if request.user.is_authenticated %}
        Controller.apply_for(data);
        {% else %}
        $('#id_apply').modal({'show': false});
        Controller.alert();
        {% endif %}
        e.preventDefault();
    });
    $('#id_score form').submit(function(e){
        var data = $(this).serialize();
        Controller.score(data);
        e.preventDefault();
    });

    {%for i in apply_set%}
        $("#sec_apply").append(View.apply_for({{i.id}}, "{{i.invited.username}}", "{{i.skill}}", "{{i.reason}}"));
    {% endfor %}
    
    //获取所有Elements 	
    {% for e in elements %}
        {% if e.category == 'text' %}
        $('article').append(View.Element.text("{%url show_element e.id%}", '{{e.content|safe|cut:"'"}}', '{{e.title}}'));
        {% endif %}
        
        {% if e.category == 'line' %}
        $('article').append(View.Element.line("{%url show_element e.id%}" , '{{e.content}}'));
        {% endif %}
        
        {% if e.category == 'image' %}
        var imageSrc = '{{e.content}}'.toString();
        $('article').append(View.Element.image("{%url show_element e.id%}", imageSrc, '{{e.title}}'));
        {% endif %}
    {% endfor %}
    //Elements 读取结束
    
	$('#id_score_score>option[value={{score}}]').attr('selected', 'selected');
	
	$('.class_work_quit').click(function(e){
		var answer = confirm('确定？');
		if (answer) {
        	var uid = $(this).data('uid');
        	$.ajax({type: 'get', url: '{%url ajax_user_quit %}', data:{'uid': uid, 'wid': {{work.id}}},
		    	success: function(data){
					var data = JSON.parse(data);
				    if (data.state != 'done') {
  						$('#alertModal .modal-body p').text(data.error);
  				        $('#alertModal').modal({'show': true});
  					} else {
              location.reload();
            }
				},
				error: function(jqXHR, textStatus){
					$('#alertModal .modal-body p').text('something wrong');
		            $('#alertModal').modal({'show': true});
				},
		    });
        }
    });
})

var View = {
	Element : {
    text : function(t_url, content, title){
      return '<div class="row element">'+
    '<div class="span1"><span class="label label-success">文字</span></div>'+
    '<h3 class="title">'+title+'</h3>'+
    '<div class="span11">'+content+'</div>'+
    '</div>'},
    image : function(t_url, name, title){
      return '<div class="row element">'+
    '<div class="span1"><span class="label label-success">图片</span></div>'+
    '<h3 class="title">'+title+'</h3>'+
    '<img class="span11" src="/media/'+name+'"></p>'+
    //'<toolbar class="span11" name="toolbar" style="display:none;"><a href="#" name="edit">编辑</a> <a href="#" name="delete">删除</a></toolbar>'+
    '</div>'},
    line : function(t_url, name){
      return '<div class="row element"><a href="' + t_url +'">'+
    '<div class="span1"><span class="label success">分割线</span></div>'+
    '<p class="span11">'+name+'</p>'+
    '</a></div>'},
  },
};
var Controller = {
    alert : function(){
        $('#alertModal .modal-body p').text('您还没有登录，请先登录');
        $('#alertModal .modal-footer a').attr("href", "/login/?next={%url show_work work.id%}");
        $('#alertModal .modal-footer a').text(">>跳转到登录页面");
        $('#alertModal').modal({'show': true});
    },
    apply_for : function(data){
		$.ajax({
            url : '{%url ajax_user_apply %}', 
            type: 'post', 
            data: data,
        	success: function(data){
		    	var data = JSON.parse(data, status);
		        if (data.state != 'done') {
    					$('#alertModal .modal-body p').text(data.error);
              $('#alertModal .modal-footer a').attr("data-dismiss", "modal");
                    $('#alertModal .modal-footer a').text("确定");
    		            $('#alertModal').modal({'show': true});
    				} else {
              alert("apply done");
            }
		    },
		    error: function(jqXHR, textStatus){
		    	$('#alertModal .modal-body p').text('something wrong');
          $('#alertModal .modal-footer a').attr("data-dismiss", "modal");
                $('#alertModal .modal-footer a').text("确定");
                $('#alertModal').modal({'show': true});
		    },
        });
        $('#id_apply').modal('hide');
	},
	score : function(data){
		$.ajax({
            url : '{%url ajax_work_grade %}', 
            type: 'get', 
            data: data,
            success: function(data){
              var data = JSON.parse(data, status);
              if (data.state != 'done') {
                $('#alertModal .modal-body p').text(data.error);
                $('#alertModal .modal-footer a').attr("data-dismiss", "modal");
                $('#alertModal .modal-footer a').text("确定");
		            $('#alertModal').modal({'show': true});
				      } else {
                $('#id_average_score').text(data.average_score);
                $('#id_score_count').text(data.score_count);
              }
		        },
		        error: function(jqXHR, textStatus){
		    	     $('#alertModal .modal-body p').text('something wrong');
               $('#alertModal .modal-footer a').attr("data-dismiss", "modal");
                $('#alertModal .modal-footer a').text("确定");
               $('#alertModal').modal({'show': true});
		        },
        });
    	$('#id_score').modal('hide');
	},
    follow : function(btn, wid, action){
        $.ajax({type: 'get', url: '{%url ajax_work_follow %}', data:{'wid': wid, 'action': action}, 
            success: function(data){
                var data = JSON.parse(data, status);
                data.action == 'follow' ? btn.text('取消').removeClass('btn-primary').data('action', 'unfollow'):btn.text('关注').addClass('btn-primary').data('action', 'follow');
            },
            error: function(jqXHR, textStatus){
                Controller.alert();
            }
        });
    },
};
</script>
{% endblock %}
